// This is your Prisma schema file
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  DOUTOR
  CLINICA_ADMIN
  SUPER_ADMIN
}

enum ChatStatus {
  BOT
  HANDOFF
  CLOSED
}

enum SenderType {
  IA
  PACIENTE
  DOUTOR
  TOOL
}

model Clinica {
  id       Int     @id @default(autoincrement())
  nome     String
  cnpj     String? @unique
  endereco String?
  telefone String?

  // --- Campos para o Multi-Tenant (WhatsApp Opção 2) ---
  // 1. Chaves da API do WhatsApp (que o admin da clínica vai preencher no painel)
  whatsappToken   String?
  whatsappPhoneId String?

  // 2. Chaves do Webhook Dinâmico (que o NOSSO sistema gera)
  webhookUrlId       String @unique @default(uuid())
  webhookVerifyToken String @default(uuid())

  // --- Horário de Funcionamento da Clínica ---
  horarioInicio String? // "08:00" - Horário de abertura da clínica
  horarioFim    String? // "18:00" - Horário de fechamento da clínica
  pausaInicio   String? // "12:00" - Início do intervalo de almoço (opcional)
  pausaFim      String? // "13:00" - Fim do intervalo de almoço (opcional)

  // --- Relacionamentos (Quais dados pertencem a esta clínica) ---
  doutores  Doutor[]
  pacientes Paciente[]
  servicos  Servico[]
}

model Doutor {
  id            Int     @id @default(autoincrement())
  nome          String
  email         String  @unique
  senha         String
  especialidade String?

  role Role @default(DOUTOR)

  // --- Horário de Almoço do Doutor ---
  pausaInicio String? // "12:00" - Início do intervalo de almoço (opcional)
  pausaFim    String? // "13:00" - Fim do intervalo de almoço (opcional)

  // --- Dias Bloqueados (0 = Domingo, 1 = Segunda, ..., 6 = Sábado) ---
  diasBloqueados Int[] @default([]) // Array de dias da semana bloqueados

  clinicaId Int?
  clinica   Clinica? @relation(fields: [clinicaId], references: [id], onDelete: Cascade)

  horarios     Horario[]
  agendamentos Agendamento[]
  indisponibilidades Indisponibilidade[]
}

// Horários que o doutor ATENDE (para a IA saber)
model Horario {
  id          Int     @id @default(autoincrement())
  diaSemana   Int // 0 = Domingo, 1 = Segunda
  inicio      String // "08:00"
  fim         String // "18:00"
  pausaInicio String? // "12:00"
  pausaFim    String? // "14:00"
  doutorId    Int
  doutor      Doutor  @relation(fields: [doutorId], references: [id])
}

model Paciente {
  id           Int           @id @default(autoincrement())
  nome         String
  telefone     String
  agendamentos Agendamento[]
  historicos   HistoricoPaciente[]
  chatStatus   ChatStatus @default(BOT)
  chatMessages ChatMessage[]

  clinicaId Int?
  clinica   Clinica? @relation(fields: [clinicaId], references: [id], onDelete: Cascade)

  @@unique([telefone, clinicaId])
}

model Servico {
  id           Int           @id @default(autoincrement())
  nome         String
  descricao    String        @db.Text
  duracaoMin   Int
  preco        Float
  agendamentos Agendamento[]

  clinicaId Int
  clinica   Clinica @relation(fields: [clinicaId], references: [id], onDelete: Cascade)
}

model Agendamento {
  id             Int      @id @default(autoincrement())
  dataHora       DateTime
  pacienteId     Int
  paciente       Paciente @relation(fields: [pacienteId], references: [id], onDelete: Cascade)
  doutorId       Int
  doutor         Doutor   @relation(fields: [doutorId], references: [id])
  servicoId      Int
  servico        Servico  @relation(fields: [servicoId], references: [id])
  status         String   // "confirmado", "pendente_ia", "cancelado"
  relatoPaciente String?  @db.Text // O que o paciente disse para realizar o agendamento
  entendimentoIA String?  @db.Text // Resumo/análise da IA sobre o que o paciente relatou
  historicos     HistoricoPaciente[]
}

model HistoricoPaciente {
  id            Int          @id @default(autoincrement())
  descricao     String       @db.Text
  realizadoEm   DateTime     @default(now())
  pacienteId    Int
  agendamentoId Int?
  createdAt     DateTime     @default(now())

  paciente   Paciente    @relation(fields: [pacienteId], references: [id], onDelete: Cascade)
  agendamento Agendamento? @relation(fields: [agendamentoId], references: [id], onDelete: SetNull)

  @@index([pacienteId, realizadoEm])
}

model ChatMessage {
  id           Int        @id @default(autoincrement())
  content      String     @db.Text
  senderType   SenderType
  createdAt    DateTime   @default(now())
  tool_call_id String?
  tool_name    String?
  pacienteId   Int
  paciente     Paciente   @relation(fields: [pacienteId], references: [id], onDelete: Cascade)

  @@index([pacienteId, createdAt])
}

// Períodos em que o doutor está indisponível (cirurgias, afastamentos, etc.)
model Indisponibilidade {
  id        Int      @id @default(autoincrement())
  inicio    DateTime
  fim       DateTime
  motivo    String?  @db.Text
  doutorId  Int
  doutor    Doutor   @relation(fields: [doutorId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@index([doutorId, inicio, fim])
}
